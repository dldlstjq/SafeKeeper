# ë°°í¬

## ğŸ› ï¸1. ì‹œìŠ¤í…œ í™˜ê²½

### **AWS EC2**

Ubuntu 20.04 LTS

Jenkins 2.334

Nginx 1.18.0

Docker 20.10.14

### **Database**

MySQL 8.0.28

RDS(Amazon RDS)

## ğŸ‘‘2. ê¸°ìˆ  ìŠ¤íƒ

### **Frontend**

IDE: VSCode

Node JS 16.13.x

Language: HTML5, Javascript, CSS3

Library: React 17.0.2, SCSS, TypeScript, Axios,

Framework: Material-UI

### **Backend**

IDE: IntelliJ 2021.3.1

Language: Java 1.8

Framework: Spring Boot 2.4.5

Library: JWT, Spring-Boot-JPA, 

### **Model**

IDE : Google colab, VSCode, jupyternotebook

Language : python

Framework : tensorflow, pytorch, onnx, tensorflow-js

Library : teachablemachine

## ğŸ·3. Safetykeeper **ë°°í¬ ìˆœì„œ(EC2)**

1. nginxë¥¼ ì„¤ì¹˜ í›„ ì„¤ì •í•´ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì—­í• ì„ í•˜ë„ë¡ í•©ë‹ˆë‹¤.
2. openviduë¥¼ ì„¤ì¹˜í•´ ì‹¤í–‰ì‹œí‚µë‹ˆë‹¤.
3. mysqlì„ ë°±ì—”ë“œë¥¼ ì´ìš©í•´ ë¹Œë“œ í›„ ì‹¤í–‰ ì‹œí‚µë‹ˆë‹¤.
4. frontendë¥¼ ë¹Œë“œ í•˜ì—¬ nginxì™€ ë¹Œë“œëœ íŒŒì¼ì„ ì´ë¯¸ì§€í™” ì‹œì¼œ ì»¨í…Œì´ë„ˆë¥¼ ë§Œë“­ë‹ˆë‹¤.
5. backendë¥¼ ë¹Œë“œ í•˜ì—¬ ë°°í¬ íŒŒì¼ì¸ jar íŒŒì¼ì„ ìƒì„±í•´ ì´ë¯¸ì§€í™” í›„ ì»¨í…Œì´ë„ˆë¡œ ë§Œë“­ë‹ˆë‹¤.
6. Jenkinsë¥¼ ì´ìš©í•´ ìœ„ì— ë§Œë“  ë¹Œë“œ íŒŒì¼ì„ docker hubì— ì—…ë¡œë“œ í•©ë‹ˆë‹¤
7. ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ docker-image-pull.shë¥¼ ì‹¤í–‰í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´í•˜ì—¬ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰ì‹œí‚µë‹ˆë‹¤.

## ğŸ¹4. Nginx

ì›¹ì„œë²„ì™€ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì—­í• ì„ í•˜ëŠ” nginxë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

**Nginx ì„¤ì¹˜**

```bash
$ sudo apt install nginx
```

1. Safetykeeper ****í”„ë¡œì íŠ¸ì— ëŒ€í•œ ì„¤ì •íŒŒì¼ì„ ë§Œë“¤ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•©ë‹ˆë‹¤.

```bash
$ vi /etc/nginx/sites-available/í”„ë¡œì íŠ¸ëª… 
```

```xml
server {

        location /{ # í”„ë¡ íŠ¸ì•¤ë“œ
                proxy_pass http://localhost:3000;
        }

        location /api { # ë°±ì—”ë“œ
                proxy_pass http://localhost:8080/api;
        }

        location /swagger-ui {
                proxy_pass http://localhost:8080/swagger-ui/#/;
        }

        location /vonovono{
                proxy_pass http://localhost:8080/api;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "Upgrade";
        }

		listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/j6d101.p.ssafy.io/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/j6d101.p.ssafy.io/privkey.pem; # managed by Certbot
    # include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = j6d101.p.ssafy.io) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

        listen 80;
        server_name j6d101.p.ssafy.io;
    return 404; # managed by Certbot
}
```

1. ì €ì¥ í›„, í•´ë‹¹ íŒŒì¼ì˜ ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ë‹¤ìŒ ê²½ë¡œì— ì¶”ê°€í•©ë‹ˆë‹¤.

```bash
$ ln -s /etc/nginx/sites-available/í”„ë¡œì íŠ¸ëª… /etc/nginx/sites-enabled/í”„ë¡œì íŠ¸ëª…
```

1. ì˜¬ë°”ë¥¸ ë¬¸ë²•ì¸ì§€ ê²€ì‚¬í•˜ê³ , ë‹¤ì‹œ ì¬ì‹¤í–‰ í•©ë‹ˆë‹¤.

```bash
$ sudo nginx -t
$ sudo service nginx restart
$ sudo systemctl status nginx
```

1. ë‹¨, HTTPSë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ì•„ì•¼ í•©ë‹ˆë‹¤. ì¸ì¦ì„œëŠ” ìµœì´ˆ 1íšŒë§Œ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤.

```bash
$ sudo apt-get install letsencrypt
$ sudo letsencrypt certonly --standalone -d j6d101.p.ssafy.io
```

## ğŸ“·5. OpenVidu

WebRTCë¥¼ ì´ìš©í•œ í™”ìƒíšŒì˜ë¥¼ ì´ìš©í•˜ê¸° ìœ„í•´ OpenViduë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. 

ì„¤ì¹˜ì™€ ì‚¬ìš©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

**OpenVidu ì„¤ì¹˜**

```bash
cd /opt   # openviduëŠ” /opt ë””ë ‰í† ë¦¬ì— ì„¤ì¹˜ë˜ëŠ”ê²Œ ê¶Œì¥
sudo curl https://s3-eu-west-1.amazonaws.com/aws.openvidu.io/install_openvidu_latest.sh | sudo bash
```

**OpenVidu ì„¤ì •íŒŒì¼**

```bash
cd /opt # openviduëŠ” /opt ë””ë ‰í† ë¦¬ì— ì„¤ì¹˜ë˜ëŠ”ê²Œ ê¶Œì¥
sudo vi .env
DOMAIN_OR_PUBLIC_IP=<Linux ì„œë²„ì˜ public ip ì£¼ì†Œ ë˜ëŠ” ë„ë©”ì¸>
OPENVIDU_SECRET=<ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸ ì…ë ¥>
CERTIFICATE_TYPE=letsencrypt # default ê°’ì€ selfsignedì§€ë§Œ selfsigned ë°©ì‹ ì‚¬ìš©ì‹œ ë³´ì•ˆ ë¬¸ì œë¥¼ ì•¼ê¸°
							 # SSL í‚¤ê°€ ìˆë‹¤ë©´ owncert ë°©ì‹ìœ¼ë¡œ í•˜ë˜, /owncert ë””ë ‰í† ë¦¬ ì•ˆì— í‚¤ê°€ ìˆì–´ì•¼ í•¨
LETSENCRYPT_EMAIL=<ì´ë©”ì¼>
HTTP_PORT=80
HTTPS_PORT=443
# HTTP_PORTì™€ HTTPS_PORTëŠ” letsencrypt ë°©ì‹ì˜ í‚¤ë¥¼ ë°œê¸‰ ë°›ê¸° ì „ê¹Œì§„ ê¸°ë³¸ í¬íŠ¸ì¸ 80, 443ì„ ì‚¬ìš©í•´ì•¼ í•¨.
# í‚¤ë¥¼ ë°œê¸‰ë°›ê³  ë‚œ í›„ë¶€í„°ëŠ” í¬íŠ¸ ë³€ê²½í•´ë„ ë¬´ë°©
```

**OpenVidu ì‹¤í–‰**

```bash
cd /opt/openvidu
sudo ./openvidu start
```

## ğŸ“¦6. dockerì™€

ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì»¨í…Œì´ë„ˆì— ë‹´ì•„ ë°°í¬í•˜ê¸° ìœ„í•´ dockerë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

**docker ì„¤ì¹˜ ë°©ë²•**

```bash
$ sudo apt-get update
$ sudo apt-get install apt-transport-https ca-certificates curl gnupg lsb-release
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
$ echo \
  "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
$ sudo apt-get update
$ sudo apt-get install docker-ce docker-ce-cli containerd.io
```

**docker ì‚¬ìš© ì˜ˆì‹œ**

```bash
$ docker run -itd --name jenkins -p 8080:8080 -p 50000:50000 \
-v /docker/jenkins:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock \
-e TZ=Asia/Seoul -u root jenkins/jenkins:latest
```

**docker hubë¡œ  image ì„¤ì¹˜(shell íŒŒì¼/**docker-image-pull.sh**)**

```bash
#!/bin/bash

# docker container stop
docker stop fe-react
docker stop be-spring

# docker container delete
docker rm fe-react
docker rm be-spring

#docker image delete
docker rmi ... #fe-react image
docker rmi ... #be-spring image

# jenkins build image pull
docker pull ... #fe-react image
docker pull ... #be-spring image

#docker run container
docker run -it -d --privileged --restart always --name fe-react -p 3000:3000 ... #fe-react image
docker run -it -d --privileged --restart always --name be-spring -p 8080:8080 ... #be-spring image
```

docker-image-pull **ì‚¬ìš© ì˜ˆì‹œ**

docker-image-pull.sh íŒŒì¼ì´ ìˆëŠ” ìœ„ì¹˜ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ í”„ë¡ íŠ¸ ë° ë°±ì—”ë“œ ì´ë¯¸ì§€ íŒŒì¼ì„ ì„¤ì¹˜í•˜ê³  ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
~$ vi ./vonovono/docker-image-pull.sh 
```

## ğŸ‘´ğŸ»7. Jenkins Pipeline

íŒŒì´í”„ ë¼ì¸ì„ í†µí•˜ì—¬ ë¹Œë“œ ë° ë„ì»¤í—ˆë¸Œì— ì´ë¯¸ì§€ ì—…ë¡œë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.

```bash
pipeline {
    agent any

    stages {
        stage('gitlab clone') {
            steps {
                git branch : 'develop',
                credentialsId: 'SafeKeeper', url: 'https://lab.ssafy.com/s06-ai-image-sub2/S06P22D101'
            }
        }
        stage('Build') {
            parallel {
                 stage('Frontend Build'){
                    steps {
                        dir('fe') {
                            sh 'ls -al'
                            sh 'docker build . -t ...{fe image}'
                        } 
                    }
                }   
                stage('Backend Build'){
                    steps {
                        dir('backend-java') {
                            sh "chmod +x gradlew"
                            sh'''
                                echo build start
                                ./gradlew clean bootJar
                            '''
                            sh 'docker build . -t ...{be image}'

                        } 
                    }
                }      
            }
        }
        stage('Upload') {
            parallel {
                 stage('Frontend Upload'){
                    steps {
                        dir('fe') {
                            sh 'docker push ...{fe image}'
                        } 
                    }
                }   
                stage('Backend Upload'){
                    steps {
                        dir('backend-java') {
                            sh 'JARNAME=$(find ./build/libs/*.jar | cut -d - -f 4)'
                            sh 'docker push  ...{be image}'

                        } 
                    }
                }      
            }
        }
        
        stage('Deploy') {
            steps {
                dir('backend-java') {
                  sh 'docker rmi $(docker images -q)'
                }
                    
            }
        }
    }
}
```

## ğŸ”7. **í”„ë¡œì íŠ¸ ì†ì„± íŒŒì¼ ëª©ë¡**

DB ì •ë³´, í† í° ì •ë³´ ë° ê°ì¢… APIì˜ KEY ê°’ ë“±ì„ ë”°ë¡œ ë³´ê´€í•˜ì˜€ìŠµë‹ˆë‹¤. 

í•´ë‹¹ íŒŒì¼ì€ backend-java/src/main/resources/application.propertiesì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

```yaml
#it will be set build date by gradle. if this value is @build.date@, front-end is development mode
build.date=@build.date@
server.port=8080
server.address=0.0.0.0
server.servlet.contextPath=/
# Charset of HTTP requests and responses. Added to the "Content-Type" header if not set explicitly.
server.servlet.encoding.charset=UTF-8
# Enable http encoding support.
server.servlet.encoding.enabled=true
# Force the encoding to the configured charset on HTTP requests and responses.
server.servlet.encoding.force=true

# for SPA
spring.resources.static-locations=classpath:/dist/
spa.default-file=/dist/index.html
spring.mvc.throw-exception-if-no-handler-found=true
spring.resources.add-mappings=false

# Swagger
springfox.documentation.swagger.use-model-v3=false

#database
spring.jpa.hibernate.naming.implicit-strategy=org.springframework.boot.orm.jpa.hibernate.SpringImplicitNamingStrategy
spring.jpa.hibernate.naming.physical-strategy=org.springframework.boot.orm.jpa.hibernate.SpringPhysicalNamingStrategy
spring.jpa.hibernate.ddl-auto=update
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL57Dialect
spring.data.web.pageable.one-indexed-parameters=true
spring.datasource.url={url}
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.hikari.username={username}
spring.datasource.hikari.password={password}

# jwt
jwt.secret={jwt}
# unit is ms. 15 * 24 * 60 * 60 * 1000 = 15days
jwt.expiration=1296000000

#logging
logging.file.name=./ssafy-web.log
logging.level.root=INFO
logging.level.com.samsung.security=DEBUG
logging.level.org.springframework.web=DEBUG
logging.level.org.apache.tiles=INFO
logging.level.org.sringframework.boot=DEBUG
logging.level.org.sringframework.security=DEBUG

spring.devtools.livereload.enabled=true

#gzip compression
server.compression.enabled=true
server.compression.mime-types=application/json,application/xml,text/html,text/xml,text/plain,application/javascript,text/css

#for health check
management.servlet.context-path=/manage
management.health.db.enabled=true
management.health.default.enabled=true
management.health.diskspace.enabled=true
```